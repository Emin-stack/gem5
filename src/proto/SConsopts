# Copyright 2020 Google, Inc.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met: redistributions of source code must retain the above copyright
# notice, this list of conditions and the following disclaimer;
# redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution;
# neither the name of the copyright holders nor the names of its
# contributors may be used to endorse or promote products derived from
# this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

Import('*')

from gem5_scons import warning
from gem5_scons.util import readCommand, compareVersions

import gem5_scons

with gem5_scons.Configure(main) as conf:
    # Check for the protobuf compiler
    conf.env['HAVE_PROTOC'] = False
    protoc_version = []
    try:
        protoc_version = readCommand([main['PROTOC'], '--version']).split()
    except Exception as e:
        warning('While checking protoc version:', str(e))

    # Based on the availability of the compress stream wrappers, require 2.1.0.
    min_protoc_version = '2.1.0'

    # First two words should be "libprotoc x.y.z"
    if len(protoc_version) < 2 or protoc_version[0] != 'libprotoc':
        warning('Protocol buffer compiler (protoc) not found.\n'
                'Please install protobuf-compiler for tracing support.')
    elif compareVersions(protoc_version[1], min_protoc_version) < 0:
        warning('protoc version', min_protoc_version, 'or newer required.\n'
                'Installed version:', protoc_version[1])
    else:
        # Attempt to determine the appropriate include path and
        # library path using pkg-config, that means we also need to
        # check for pkg-config. Note that it is possible to use
        # protobuf without the involvement of pkg-config. Later on we
        # check go a library config check and at that point the test
        # will fail if libprotobuf cannot be found.
        if conf.env['HAVE_PKG_CONFIG']:
            conf.CheckPkgConfig('protobuf', '--cflags', '--libs-only-L')
        conf.env['HAVE_PROTOC'] = True

    # If we have the protobuf compiler, also make sure we have the
    # development libraries. If the check passes, libprotobuf will be
    # automatically added to the LIBS environment variable. After
    # this, we can use the HAVE_PROTOBUF flag to determine if we have
    # got both protoc and libprotobuf available.
    conf.env['CONF']['HAVE_PROTOBUF'] = conf.env['HAVE_PROTOC'] and \
        conf.CheckLibWithHeader('protobuf', 'google/protobuf/message.h',
                                'C++', 'GOOGLE_PROTOBUF_VERIFY_VERSION;')
	# TODO(GOOGLE_PROTOBUF_VERIFY_VERSION can't be found)

# If we have the compiler but not the library, print another warning.
if main['HAVE_PROTOC'] and not main['CONF']['HAVE_PROTOBUF']:
    warning('Did not find protocol buffer library and/or headers.\n'
            'Please install libprotobuf-dev for tracing support.')

if main['CONF']['HAVE_PROTOBUF']:
    main.TagImplies('protobuf', 'gem5 lib')
    # protoc relies on the fact that undefined preprocessor symbols are
    # explanded to 0 but since we use -Wundef they end up generating
    # warnings.
    main.Append(CCFLAGS='-DPROTOBUF_INLINE_NOT_IN_HEADERS=0')
    conf.env.Append(LIBS=['protobuf',
		    'absl_log_internal_check_op',
		    'absl_leak_check',
		    'absl_die_if_null',
		    'absl_log_internal_conditions',
		    'absl_log_internal_message',
		    'absl_examine_stack',
		    'absl_log_internal_format',
		    'absl_log_internal_proto',
		    'absl_log_internal_nullguard',
		    'absl_log_internal_log_sink_set',
		    'absl_log_sink',
		    'absl_log_entry',
		    'absl_flags',
		    'absl_flags_internal',
		    'absl_flags_marshalling',
		    'absl_flags_reflection',
		    'absl_flags_private_handle_accessor',
		    'absl_flags_commandlineflag',
		    'absl_flags_commandlineflag_internal',
		    'absl_flags_config',
		    'absl_flags_program_name',
		    'absl_log_initialize',
		    'absl_log_globals',
		    'absl_log_internal_globals',
		    'absl_raw_hash_set',
		    'absl_hash',
		    'absl_city',
		    'absl_low_level_hash',
		    'absl_hashtablez_sampler',
		    'absl_statusor',
		    'absl_status',
		    'absl_cord',
		    'absl_cordz_info',
		    'absl_cord_internal',
		    'absl_cordz_functions',
		    'absl_exponential_biased',
		    'absl_cordz_handle',
		    'absl_crc_cord_state',
		    'absl_crc32c',
		    'absl_crc_internal',
		    'absl_crc_cpu_detect',
		    'absl_bad_optional_access',
		    'absl_str_format_internal',
		    'absl_strerror',
		    'absl_synchronization',
		    'absl_graphcycles_internal',
		    'absl_kernel_timeout_internal',
		    'absl_stacktrace',
		    'absl_symbolize',
		    'absl_debugging_internal',
		    'absl_demangle_internal',
		    'absl_malloc_internal',
		    'absl_time',
		    'absl_civil_time',
		    'absl_time_zone',
		    'absl_bad_variant_access',
		    'utf8_validity',
		    'utf8_range',
		    'absl_strings',
		    'absl_string_view',
		    'absl_strings_internal',
		    'absl_base',
		    'rt',
		    'absl_spinlock_wait',
		    'absl_int128',
		    'absl_throw_delegate',
		    'absl_raw_logging_internal',
		    'absl_log_severity',
		    ])
